# 订阅风控插件 (Subscription Control)

## 功能介绍

订阅风控插件为 XBoard 提供了强大的订阅链接访问控制功能，帮助防止节点被恶意扫描和滥用。插件完全基于缓存运行，无需数据库，轻量高效。

### 主要功能

1. **UA黑名单** - 拦截特定User-Agent的访问请求
2. **IP限制** - 限制时间窗口内不同IP的访问数量
3. **访问频率限制** - 限制用户的订阅拉取频率  
4. **阅后即焚** - 限制订阅链接在指定时间内的使用次数

## 安装方法

1. 将插件文件夹 `SubscriptionControl` 复制到 `plugins/` 目录
2. 在管理面板的插件管理页面启用此插件
3. 根据需求配置插件参数

## 配置说明

### UA黑名单设置
- **启用UA黑名单**: 开启/关闭UA检测功能
- **UA黑名单列表**: 每行输入一个关键词，支持模糊匹配
  ```
  BadBot
  crawler
  spider
  python
  wget
  curl
  ```

### IP限制设置  
- **启用订阅IP限制**: 开启/关闭IP限制功能
- **时间窗口内允许的不同IP数量**: 例如设置为3，表示在时间窗口内最多允许3个不同IP访问
- **时间窗口（秒）**: 例如600秒（10分钟）

**示例场景**：设置为"3个IP，600秒"
- 用户在10分钟内从3个不同IP访问订阅，都可以正常访问
- 第4个不同的IP尝试访问时将被拦截
- 10分钟后，IP记录自动过期，重新计数

### 访问频率限制
- **启用订阅拉取频率限制**: 开启/关闭频率限制
- **时间窗口内允许的最大拉取次数**: 例如10次
- **频率限制时间窗口（秒）**: 例如86400秒（24小时）

**示例场景**：设置为"10次，86400秒"
- 用户在24小时内可以访问订阅10次
- 第11次访问将被拦截
- 使用滑动窗口算法，第一次访问24小时后才会重新计数

### 阅后即焚功能
- **启用阅后即焚功能**: 开启/关闭此功能
- **最大使用次数**: 链接在时间窗口内可被使用的次数，例如1次（真正的一次性）
- **有效时间（秒）**: 时间窗口，例如3600秒（1小时）

**示例场景**：设置为"1次，3600秒"
- 用户访问订阅链接后，立即记录使用次数为1
- 在1小时内，第二次访问时会触发：
  1. ❌ 拦截访问（返回403）
  2. 🔄 **自动重置订阅token（生成新的）**
  3. 📝 旧的订阅链接彻底失效
  4. ✅ 用户需要到网站重新获取新的订阅链接
- 1小时后，如果未达到次数上限，计数会自动重置

**使用建议**：
- 设置为 **1次** = 真正的一次性链接，访问后token立即重置，必须到网站获取新链接
- 设置为 **3-5次** = 允许多次刷新，适合正常使用，超过次数后重置token
- 设置为 **10次以上** = 限制过度频繁访问，超过次数后重置token

**重要说明**：
- ⚠️ 达到使用次数上限后，系统会**自动重置用户的订阅token**
- ⚠️ 旧的订阅链接将**永久失效**，无法再使用
- ⚠️ 用户需要登录网站，重新获取新的订阅链接
- ✅ 这是最强的安全措施，可以有效防止订阅链接泄露和滥用

## 使用示例

所有功能直接作用于普通订阅链接，无需特殊处理：
```
https://你的域名/api/v1/client/subscribe?token=用户token
```

## 工作原理

### 检查流程
插件在用户访问订阅链接时按以下顺序检查：
1. **UA黑名单** → 检查User-Agent是否在黑名单中
2. **IP限制** → 检查时间窗口内IP数量是否超限
3. **频率限制** → 检查时间窗口内访问次数是否超限
4. **阅后即焚** → 检查时间窗口内使用次数是否超限

任何一项检查不通过，直接返回403错误，后续检查不再执行。

### 缓存机制
所有数据存储在缓存中，键名格式：
- `subscription_control:ip_limit:{用户ID}` - IP限制记录
- `subscription_control:rate_limit:{用户ID}` - 频率限制记录  
- `subscription_control:usage:{用户ID}:{token}` - 阅后即焚使用记录
- `subscription_control:blocked_count:{日期}` - 每日拦截计数

## 功能详解

### UA黑名单
拦截含有黑名单关键词的User-Agent，例如：
- 爬虫: `spider`, `crawler`, `bot`
- 工具: `wget`, `curl`, `python-requests`
- 测试工具: `postman`, `insomnia`

### IP限制
防止订阅链接被多人共享使用：
- 在时间窗口内，记录不同的访问IP
- 超过设定数量后，新的IP将被拦截
- 已记录的IP可以继续访问
- 时间窗口过期后，IP记录自动清除

### 频率限制
防止恶意频繁拉取：
- 在时间窗口内，记录每次访问的时间戳
- 超过设定次数后，将被拦截
- 使用滑动窗口算法，更加精确
- 时间窗口过期后，访问记录自动清除

### 阅后即焚
限制订阅链接的使用次数，并在达到上限后自动重置token：
- 在时间窗口内，记录累计使用次数
- 达到设定次数后，会执行以下操作：
  1. 拦截当前访问（返回403）
  2. **自动生成新的订阅token**
  3. **旧的订阅链接永久失效**
  4. 用户必须到网站重新获取新链接
- 时间窗口过期后，如果未达到次数上限，使用次数会自动重置

## 典型使用场景

### 场景1：防止订阅链接泄露
```
启用IP限制: 是
IP数量: 2个
时间窗口: 86400秒（24小时）
```
效果：24小时内只允许2个不同IP访问，防止链接被多人使用

### 场景2：真正的一次性订阅（阅后即焚）
```
启用阅后即焚: 是
使用次数: 1次
有效时间: 3600秒（1小时）
```
效果：
- 第1次访问：✅ 成功，记录使用次数
- 第2次访问（1小时内）：
  - ❌ 被拦截（403错误）
  - 🔄 **自动重置订阅token**
  - 📝 旧链接永久失效
  - 用户需要登录网站获取新链接
- 1小时后（如果只访问了1次）：计数重置，可以继续使用

### 场景3：限制爬虫扫描
```
启用UA黑名单: 是
黑名单内容:
  bot
  crawler
  python
  wget
  curl
```
效果：拦截常见爬虫和工具的访问

### 场景4：防止频繁拉取
```
启用频率限制: 是
拉取次数: 30次
时间窗口: 3600秒（1小时）
```
效果：1小时内最多拉取30次，防止过度频繁请求

## 注意事项

1. ✅ 插件完全独立，不会修改XBoard核心代码
2. ✅ 所有数据存储在缓存中，不使用数据库
3. ✅ 建议使用Redis等持久化缓存驱动
4. ✅ IP限制功能需要正确配置反向代理以获取真实IP
5. ⚠️ 重启缓存服务会清空所有风控数据
6. ⚠️ 阅后即焚是基于时间窗口的，过期后会重置

## 查看日志

插件会记录详细的操作日志到 `storage/logs/laravel.log`：
- 订阅首次使用
- 订阅使用计数
- 订阅使用次数超限，已重置token
- 用户token已重置
- 订阅过期重置
- IP限制超限
- 频率限制超限
- UA黑名单拦截

日志格式示例：
```
[SubscriptionControl] 订阅使用计数 {"user_id":1,"uses":1,"max_uses":1}
[SubscriptionControl] 订阅使用次数超限，已重置token {"user_id":1,"uses":1,"max_uses":1,"old_token":"abc123"}
[SubscriptionControl] 用户token已重置 {"user_id":1,"old_token":"abc123","new_token":"def456"}
```

## 故障排除

### 插件未生效
- 确认插件已在管理面板中启用
- 检查相关功能开关是否打开
- 查看 `storage/logs/laravel.log` 中的日志

### 阅后即焚不生效
- 确认"启用阅后即焚功能"已开启
- 检查"最大使用次数"和"有效时间"的设置
- 查看日志确认是否有"订阅使用计数"记录
- 如果使用文件缓存，尝试清空缓存后重试

### IP限制不准确  
确保Nginx/Apache正确配置，传递真实IP：

**Nginx配置示例：**
```nginx
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
```

**Cloudflare用户：**
插件会自动识别 `CF-Connecting-IP` 头部

### 误拦截正常用户
- 检查UA黑名单是否设置过于宽泛
- 适当增加IP限制数量和时间窗口
- 适当增加频率限制和阅后即焚的阈值
- 检查日志确认具体拦截原因

## 性能优化建议

1. **使用Redis缓存**
```env
CACHE_DRIVER=redis
```

2. **合理设置时间窗口**
- IP限制时间窗口：建议10-30分钟
- 频率限制时间窗口：建议1-24小时
- 阅后即焚有效期：建议5-60分钟

3. **合理设置限制值**
- IP数量：2-5个（根据用户使用习惯）
- 频率次数：10-50次（根据客户端更新频率）
- 阅后即焚次数：1-10次（1次最严格）

## 技术特点

- 🚀 **零数据库** - 完全基于缓存，无需创建表
- 🎯 **即插即用** - 安装即可使用，无需额外配置
- ⚡ **高性能** - 缓存操作，对订阅速度影响极小
- 🔒 **安全可靠** - 多层防护，有效防止滥用
- 📝 **详细日志** - 记录所有拦截和使用信息
- 🛠️ **易于调试** - 日志清晰，问题易排查

## 更新日志

### v1.0.1
- 修改阅后即焚逻辑，直接限制普通订阅链接的使用次数
- 增加详细的操作日志
- 优化时间窗口过期后的重置逻辑

### v1.0.0
- 初始版本发布
- 支持UA黑名单
- 支持IP限制  
- 支持访问频率限制
- 支持阅后即焚功能
- 完全基于缓存，无需数据库

## 许可证

本插件遵循与XBoard相同的许可证。